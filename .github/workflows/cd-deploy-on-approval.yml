name: Deploy on Approval

on:
  repository_dispatch:
    types: [deploy-approval]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Parse Deployment Payload
        id: parse_payload
        run: |
          IMAGE_TAG="${{ github.event.client_payload.image_tag || github.event.client_payload.value || 'latest' }}"
          IMAGE_TAG_SHORT="${IMAGE_TAG:0:7}"
          USER="${{ github.event.client_payload.user || 'system' }}"

          echo "ğŸ“¦ Deployment Approval Received"
          echo "Image Tag: $IMAGE_TAG"
          echo "Image Tag Short: $IMAGE_TAG_SHORT"
          echo "User: $USER"

          echo "DEPLOY_IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "DEPLOY_IMAGE_TAG_SHORT=$IMAGE_TAG_SHORT" >> $GITHUB_ENV
          echo "DEPLOY_USER=$USER" >> $GITHUB_ENV

      - name: Send Deployment Start Notification
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš€ *Production ë°°í¬ ì‹œì‘*\\n\\nâ€¢ ì´ë¯¸ì§€: ${DEPLOY_IMAGE_TAG_SHORT}\\nâ€¢ ì‚¬ìš©ì: ${DEPLOY_USER}\\nâ€¢ ìƒíƒœ: ë°°í¬ ì§„í–‰ ì¤‘...\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "âš ï¸ Slack notification failed (non-blocking)"

      - name: Mock Infrastructure Deployment
        run: |
          echo "ğŸ—ï¸  Simulating infrastructure deployment with Terraform..."
          echo ""
          echo "In production, this would execute:"
          echo "  terraform init"
          echo "  terraform plan -var=\"docker_image_tag=${DEPLOY_IMAGE_TAG}\""
          echo "  terraform apply -var=\"docker_image_tag=${DEPLOY_IMAGE_TAG}\" -auto-approve"
          echo ""
          echo "Infrastructure components that would be updated:"
          echo "  â€¢ ECS Task Definition (new image)"
          echo "  â€¢ ECS Service (rolling update)"
          echo "  â€¢ CodeDeploy Deployment Group (blue/green)"
          echo "  â€¢ ALB Target Groups (traffic switching)"
          echo ""
          sleep 3
          echo "âœ… Infrastructure deployment simulation complete"

      - name: Mock Health Check
        run: |
          echo "ğŸ¥ Running health checks..."
          echo "â€¢ Checking ECS service health"
          echo "â€¢ Verifying target group health"
          echo "â€¢ Validating application endpoints"
          sleep 2
          echo "âœ… All health checks passed"

      - name: Send Final Success Notification (Webhook)
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âœ… *v${DEPLOY_IMAGE_TAG_SHORT} Production ë°°í¬ ì„±ê³µ!* ğŸ‰\\n\\nâ€¢ ì´ë¯¸ì§€ íƒœê·¸: ${DEPLOY_IMAGE_TAG}\\nâ€¢ ì‚¬ìš©ì: ${DEPLOY_USER}\\nâ€¢ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S')\\nâ€¢ ìƒíƒœ: ëª¨ë“  í—¬ìŠ¤ ì²´í¬ í†µê³¼\\n\\nğŸ’¡ *ì°¸ê³ :* ì‹¤ì œ í”„ë¡œë•ì…˜ì—ì„œëŠ” Grafana ëŒ€ì‹œë³´ë“œì—ì„œ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "âš ï¸ Slack notification failed (non-blocking)"

      - name: Send Final Success Notification (Bot API)
        if: success() && env.SLACK_BOT_TOKEN != ''
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        uses: slackapi/slack-github-actions@v1.24.0
        with:
          channel-id: ${{ secrets.SLACK_CHANNEL_ID || 'C12345678' }}
          payload: |
            {
              "text": "ğŸš€ v${DEPLOY_IMAGE_TAG_SHORT} ë°°í¬ ì„±ê³µ! ğŸ‰",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *v${DEPLOY_IMAGE_TAG_SHORT} Production ë°°í¬ ì„±ê³µ!* ğŸ‰\n\nâ€¢ ì´ë¯¸ì§€ íƒœê·¸: ${DEPLOY_IMAGE_TAG}\nâ€¢ ì‚¬ìš©ì: ${DEPLOY_USER}\nâ€¢ ëª¨ë“  í—¬ìŠ¤ ì²´í¬ í†µê³¼"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ’¡ *ì°¸ê³ :* ì‹¤ì œ í”„ë¡œë•ì…˜ì—ì„œëŠ” Grafana ëŒ€ì‹œë³´ë“œì—ì„œ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                  }
                }
              ]
            }

      - name: Send Failure Notification
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âŒ *ë°°í¬ ì‹¤íŒ¨*\\n\\nâ€¢ ì´ë¯¸ì§€: ${DEPLOY_IMAGE_TAG_SHORT}\\nâ€¢ ì‚¬ìš©ì: ${DEPLOY_USER}\\nâ€¢ ì—ëŸ¬: GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "âš ï¸ Slack notification failed (non-blocking)"
