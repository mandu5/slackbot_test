name: Dev Deploy

on:
  repository_dispatch:
    types:
      - dev_deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Parse Slack Message
        id: parse_message
        run: |
          MESSAGE="${{ github.event.client_payload.message || '' }}"
          ORIGINAL_MESSAGE="${{ github.event.client_payload.original_message || '' }}"
          USER="${{ github.event.client_payload.user || 'unknown' }}"
          TAG="${{ github.event.client_payload.tag || 'latest' }}"

          echo "ğŸ“¥ Received repository_dispatch event"
          echo "Message: $MESSAGE"
          echo "Original: $ORIGINAL_MESSAGE"
          echo "User: $USER"
          echo "Tag: $TAG"

          # Check if this is a deployment request
          if [[ "$MESSAGE" == *"ë°°í¬"* ]] || [[ "$MESSAGE" == *"deploy"* ]] || [[ -z "$MESSAGE" ]]; then
            echo "âœ… Deploy request confirmed"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No deployment needed for this message"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

          echo "DEPLOY_TAG=$TAG" >> $GITHUB_ENV
          echo "DEPLOY_USER=$USER" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        if: steps.parse_message.outputs.should_deploy == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        if: steps.parse_message.outputs.should_deploy == 'true'
        id: docker_build
        run: |
          echo "ğŸ”¨ Building Docker image..."
          IMAGE_TAG="${DEPLOY_TAG:-${{ github.sha }}}"
          docker build -t myapp:$IMAGE_TAG .
          docker tag myapp:$IMAGE_TAG myapp:latest
          echo "âœ… Docker image built: myapp:$IMAGE_TAG"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Send Deployment Start Notification
        if: steps.parse_message.outputs.should_deploy == 'true'
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš€ *ë°°í¬ ì‹œì‘ë¨*\\n\\nâ€¢ ì‚¬ìš©ì: ${DEPLOY_USER}\\nâ€¢ ì´ë¯¸ì§€ íƒœê·¸: ${DEPLOY_TAG:-latest}\\nâ€¢ ìƒíƒœ: ë¹Œë“œ ì¤‘...\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "âš ï¸ Slack notification failed (non-blocking)"

      - name: Mock Deployment Step
        if: steps.parse_message.outputs.should_deploy == 'true'
        run: |
          echo "ğŸ“¦ Simulating deployment..."
          echo "In production, this would:"
          echo "  1. Push image to ECR"
          echo "  2. Update ECS service with new image"
          echo "  3. Wait for health checks"
          echo "  4. Switch traffic to new deployment"
          sleep 2
          echo "âœ… Deployment simulation complete"

      - name: Send Deployment Success Notification
        if: steps.parse_message.outputs.should_deploy == 'true' && success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âœ… *ë°°í¬ ì„±ê³µ!*\\n\\nâ€¢ ì´ë¯¸ì§€: ${DEPLOY_TAG:-latest}\\nâ€¢ ì‚¬ìš©ì: ${DEPLOY_USER}\\nâ€¢ ì‹œê°„: $(date +'%Y-%m-%d %H:%M:%S')\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "âš ï¸ Slack notification failed (non-blocking)"

      - name: Send Deployment Failure Notification
        if: steps.parse_message.outputs.should_deploy == 'true' && failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âŒ *ë°°í¬ ì‹¤íŒ¨*\\n\\nâ€¢ ì´ë¯¸ì§€: ${DEPLOY_TAG:-latest}\\nâ€¢ ì‚¬ìš©ì: ${DEPLOY_USER}\\nâ€¢ ì—ëŸ¬ í™•ì¸: GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "âš ï¸ Slack notification failed (non-blocking)"

      - name: Send Status via action-slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          author_name: Atlas Platform - Dev Deploy
          fields: repo,commit,message,author
          mention: here
          if_mention: failure,cancelled
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
