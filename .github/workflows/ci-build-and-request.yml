name: CI Build and Request Approval

on:
  push:
    branches:
      - main

jobs:
  build-and-request:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Image
        id: docker_build
        run: |
          echo "Building Docker image..."
          docker build -t myapp:${{ github.sha }} . || exit 1
          docker tag myapp:${{ github.sha }} myapp:latest
          echo "β… Docker image built successfully"
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Send Slack Approval Request (Webhook)
        if: success()
        run: |
          COMMIT_SHORT="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHORT:0:7}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"π€ *v${COMMIT_SHORT}* λ°°ν¬ μ¤€λΉ„ μ™„λ£!\\n\\nβ… Docker μ΄λ―Έμ§€ λΉλ“ μ„±κ³µ\\n\\nProd λ°°ν¬λ¥Ό μΉμΈν•μ‹κ² μµλ‹κΉ?\\n\\n*λ°°ν¬ λ°©λ²•:*\\nβ€Ά Slackμ—μ„ \`@SoftBank_Bot μλ™ λ°°ν¬ μ‹μ‘\` λ©”μ‹μ§€ μ „μ†΅\\nβ€Ά λλ” GitHub Actionsμ—μ„ μλ™ μΉμΈ\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "β οΈ Slack webhook notification failed (non-blocking)"

      # Bot API μ•λ¦Όμ€ slackapi/slack-github-actions μ•΅μ…μ΄ μ΅΄μ¬ν•μ§€ μ•μ•„ μ κ±°λ¨
      # μ›Ήν›… μ•λ¦Όμ΄ μ΄λ―Έ μ¶©λ¶„ν μ‘λ™ν•λ―€λ΅ Bot APIλ” μ¶”ν›„ ν•„μ”μ‹ μ¶”κ°€ μμ •
